on:
  pull_request:
    branches: [ main, development ]  # TODO remove development here
  push:
    branches: [ main, development ]
  workflow_dispatch:

name: End to end testing

jobs:
  end2end_testing:
    name: End to end test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: AlphaDIA
#            conda-env-path: |
#              /usr/share/miniconda/envs/alphadia
#              /home/runner/conda/envs
#              /home/runner/.condarc
    steps:
      - uses: actions/checkout@v3
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: ${{ matrix.python-version }}
      - name: Conda info
        shell: bash -el {0}
        run: conda info
#      - name: Setup conda cache
        # https://dev.to/epassaro/caching-anaconda-environments-in-github-actions-5hde
        # TODO we must make sure the cache is not used if anything code-related changes. Maybe just for developing?
#        uses: actions/cache@v3
#        with:
#          path: ${{ matrix.conda-env-path }}
#          key: ${{ matrix.os }}-conda-${{ hashFiles('**/requirements.txt') }}-2
#        id: conda-cache
      - name: Setup pip cache
#        if: steps.conda-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-
      - name: Pip installation with loose dependencies
#        if: steps.conda-cache.outputs.cache-hit != 'true'
        shell: bash -el {0}
        run: |
          cd misc
          . ./loose_pip_install.sh
      - name: Run e2e tests
        shell: bash -el {0}
        env:
          NEPTUNE_API_TOKEN: ${{ secrets.NEPTUNE_E2E_TOKEN }}
          NEPTUNE_PROJECT_NAME: "MannLabs/alphaDIA-e2e-tests"
        run: |
          cd tests
           . ./run_e2e_tests.sh basic_e2e
